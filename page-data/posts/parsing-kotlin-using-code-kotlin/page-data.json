{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/parsing-kotlin-using-code-kotlin/","result":{"data":{"markdownRemark":{"id":"9c92f627-1516-5f88-b87d-954e26c406c8","html":"<img src=\"/media/parsing-kotlin-using-code-kotlin/logo.svg\" width=\"75\" height=\"75\">\n<p>So you are already writing code in Kotlin and it feels great. The feeling is mutual, Kotlin is a great language and everyone loves lambdas.</p>\n<p>I’m writing about here a problem which I faced earlier where I was trying to do code analysis over Kotlin files to create a tool. The problem statement was to read the whole code and figure problems inside it.</p>\n<p>But first things first, <strong>why would you want to parse files?</strong></p>\n<ul>\n<li>Create custom documentation, I know there is <em>dokka</em> but it never worked properly for me</li>\n<li>Do code analysis over .kt files</li>\n<li>Anything else? Once you get handle to source code, it opens a lot of possibilites - you’ll see, read on</li>\n</ul>\n<h2 id=\"how\" style=\"position:relative;\"><a href=\"#how\" aria-label=\"how permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>How</h2>\n<p>The answer is right there, literally, inside the kotlin compiler!</p>\n<div class=\"gatsby-highlight\" data-language=\"groovy\"><pre class=\"language-groovy\"><code class=\"language-groovy\">implementation <span class=\"token interpolation-string\"><span class=\"token string\">\"org.jetbrains.kotlin:kotlin-compiler-embeddable:1.3.21\"</span></span></code></pre></div>\n<p>The embeddable jar has classes inside it which allow us to parse kotlin source code.</p>\n<p>We’re gonna use Intellij’s PSI formats to parse our files.</p>\n<blockquote>\n<p><strong>What is this PSI format you talk about sire?</strong></p>\n</blockquote>\n<p>Well I’m glad you asked. PSI(Program Structure Interface) is Intellij internal format used for representating files inside Intellij IDEA. More details <a href=\"https://www.jetbrains.org/intellij/sdk/docs/basics/architectural_overview/psi.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a></p>\n<p>That’s right we’re gonna parse our code in similar fashion to how Intellij does it.(ok maybe a bit substandard fashion)</p>\n<h2 id=\"show-me-code\" style=\"position:relative;\"><a href=\"#show-me-code\" aria-label=\"show me code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Show me code</h2>\n<p>First thing we need to setup a project by creating environment for Kotlin</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> project <span class=\"token keyword\">by</span> lazy <span class=\"token punctuation\">{</span>\n    KotlinCoreEnvironment<span class=\"token punctuation\">.</span><span class=\"token function\">createForProduction</span><span class=\"token punctuation\">(</span>\n            Disposer<span class=\"token punctuation\">.</span><span class=\"token function\">newDisposable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token function\">CompilerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            EnvironmentConfigFiles<span class=\"token punctuation\">.</span>JVM_CONFIG_FILES <span class=\"token comment\">//Can be JS/NATIVE_CONFIG_FILES for non JVM projects</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>project\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Remember Envrionments can be created for any language like Java because PSI is language independent, it can used to parse Java code also</p>\n<p>Once we have a <strong>project</strong> we would like to convert Kotlin source as a string to a <strong>KtFile</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">createKtFile</span><span class=\"token punctuation\">(</span>codeString<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> fileName<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        PsiManager<span class=\"token punctuation\">.</span><span class=\"token function\">getInstance</span><span class=\"token punctuation\">(</span>project<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">findFile</span><span class=\"token punctuation\">(</span>\n                <span class=\"token function\">LightVirtualFile</span><span class=\"token punctuation\">(</span>fileName<span class=\"token punctuation\">,</span> KotlinFileType<span class=\"token punctuation\">.</span>INSTANCE<span class=\"token punctuation\">,</span> codeString<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> KtFile</code></pre></div>\n<p><strong>KtFile</strong> is base representation of Kotlin Source File. It’s not a class representation, since Kotlin doesn’t necesarily need files to have classes in them. <strong>KtFile</strong> can have classes, functions etc as it’s children.</p>\n<p>A simple example would finding all <em>imports</em> in the file</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">ktFile<span class=\"token punctuation\">.</span>importList<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>imports <span class=\"token comment\">// Returns List&lt;KtImportDirective></span></code></pre></div>\n<p>Similarly we can get classes and function declarations</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">ktFile<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">{</span> psiElement <span class=\"token operator\">-></span> \n    <span class=\"token keyword\">when</span><span class=\"token punctuation\">(</span>psiElement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">is</span> KtClass <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Class }</span>\n        <span class=\"token keyword\">is</span> KtNamedFunction <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// Function }</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Go inside a function? Sure why not!</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">ktNamedFunction<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">{</span> child <span class=\"token operator\">-></span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child <span class=\"token keyword\">is</span> KtBlockExpression<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// Statements inside function</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Above snippets of code can be really useful if you want to analyze your own source code and build tools around it(such as code analysis)</p>\n<h2 id=\"practical-example\" style=\"position:relative;\"><a href=\"#practical-example\" aria-label=\"practical example permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Practical Example</h2>\n<p>I have an <a href=\"https://github.com/jitinsharma/Kotlin.someExtensions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">open source repository</a> where I keep on adding extension functions related to Android. It’s a set of files and not a complete project. So to generate <strong>.md</strong> files for the code, I had to build up something of my own instead of using dokka.</p>\n<p>The elements in PSI also allow us to access code comments. Here’s how</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> docText <span class=\"token operator\">=</span> ktFunction<span class=\"token punctuation\">.</span>docComment<span class=\"token punctuation\">.</span>text</code></pre></div>\n<p>Using this we can generate <strong>.md</strong> files for our code.</p>\n<p>Code file: <strong>ImageExtensions.kt</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n * Convert byte array to bitmap\n */</span>\n<span class=\"token keyword\">fun</span> ByteArray<span class=\"token punctuation\">.</span><span class=\"token function\">convertBytesToBitmap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Bitmap <span class=\"token operator\">=</span>\n        BitmapFactory<span class=\"token punctuation\">.</span><span class=\"token function\">decodeByteArray</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> size<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">/**\n * Convert bitmap to a byte array\n */</span>\n<span class=\"token keyword\">fun</span> Bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">convertBitmapToBytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ByteArray <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> stream <span class=\"token operator\">=</span> <span class=\"token function\">ByteArrayOutputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compress</span><span class=\"token punctuation\">(</span>Bitmap<span class=\"token punctuation\">.</span>CompressFormat<span class=\"token punctuation\">.</span>PNG<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stream<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">toByteArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>Generated doc: <strong>ImageExtensions.md</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/22a1a502afaab2936ff2e5e6c71cedf1/78415/image-extensions-doc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.75000000000001%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaklEQVQoz32S6W7bMBCE/f6v1yJNfOkWLZmHeIg6HGA6YmAXSdz8GAy1AEe733JnrMc4LQhxTn5XiMun72eK8/rwu3Ztr6AGB81gaSx9k2PNolca07piXt+pzW+fLn8NS4FdLXAuG1T0ttUQjUNbW9SlQVUY+oC+N7gIj0vr4X1E+KnDOEaIi0F2lAwYIOqAouixPxTYH0uczjXyUuDEnzSdh+gkdX2EfQvcxk3Mxhme2lj6OPE8JQ/TB9vU1fyP9X8D7wwHFyCuEsZ5aPfBUJGnYX29vWPZGC7rt6CvoTvZkGFeoKw6dGTUVo6jW1TZQH4W3UWj5KhH4VDLAEuG25Km5fZ8KbLTOGU1fr/uURYMf1XID5ZucKKyvcbhTeGcSW49Qg4BV2XSVM87lBYia5Czy19/3tIyXl5yOhdybKHUCKMjFLtTeiSGgI5ornp4HhhCxET4WzEtgnLjSOfzYH0it6R1fZx/Gvkvkf77/n8t8PYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/22a1a502afaab2936ff2e5e6c71cedf1/8ac56/image-extensions-doc.webp 240w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/d3be9/image-extensions-doc.webp 480w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/e46b2/image-extensions-doc.webp 960w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/459db/image-extensions-doc.webp 1207w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/22a1a502afaab2936ff2e5e6c71cedf1/8ff5a/image-extensions-doc.png 240w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/e85cb/image-extensions-doc.png 480w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/d9199/image-extensions-doc.png 960w,\n/static/22a1a502afaab2936ff2e5e6c71cedf1/78415/image-extensions-doc.png 1207w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/22a1a502afaab2936ff2e5e6c71cedf1/d9199/image-extensions-doc.png\"\n            alt=\"ImageExtensions.md\"\n            title=\"ImageExtensions.md\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"final-words\" style=\"position:relative;\"><a href=\"#final-words\" aria-label=\"final words permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Final Words</h2>\n<p>So we have observed how we can leverage parsing kotlin source code to create solutions around code analysis and auto documentation generation. Let me know in comments if any other use case comes to your mind.</p>\n<p>Here’s the repository for above example where markdown is auto generated\n<a href=\"https://github.com/jitinsharma/Kotlin.someExtensions\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/jitinsharma/Kotlin.someExtensions</a></p>","fields":{"slug":"/posts/parsing-kotlin-using-code-kotlin/","tagSlugs":["/tag/kotlin/","/tag/psi/"]},"frontmatter":{"date":"2019-09-10","description":" As Android codebases have moved largely to kotlin, code analysis for kotlin code presents itself as a unique problem with a utterly simple solution.","tags":["Kotlin","PSI"],"title":"Parsing Kotlin code using Kotlin","banner":null}}},"pageContext":{"slug":"/posts/parsing-kotlin-using-code-kotlin/"}},"staticQueryHashes":["1122560877","251939775","401334301"]}