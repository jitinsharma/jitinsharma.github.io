{"componentChunkName":"component---src-templates-post-template-tsx","path":"/posts/adventures-in-android-timekeeping/","result":{"data":{"markdownRemark":{"id":"4c0d5bbe-c4d3-5533-a9a3-787caa7c0cce","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2be52d1eec555424ea81a217aac71d6a/46d55/image.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 77.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBBAX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAc53roQKW//EABgQAAMBAQAAAAAAAAAAAAAAAAECAxIQ/9oACAEBAAEFAgjFJoGLDJWuY6PP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEREhAxQf/aAAgBAQAGPwK3By4Giq3Of//EABsQAQACAgMAAAAAAAAAAAAAAAEAESExEFFh/9oACAEBAAE/IVBMWoaNSKrsYGS3D1MFX7x//9oADAMBAAIAAwAAABAP7//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAEDAQE/EKf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAEBAAIDAQEAAAAAAAAAAAABEQAhMUFhUXH/2gAIAQEAAT8QVWgr6vRho09HfuQJ0mYkAuYwiN/dZw7lfVed4t5z/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2be52d1eec555424ea81a217aac71d6a/8ac56/image.webp 240w,\n/static/2be52d1eec555424ea81a217aac71d6a/d3be9/image.webp 480w,\n/static/2be52d1eec555424ea81a217aac71d6a/e46b2/image.webp 960w,\n/static/2be52d1eec555424ea81a217aac71d6a/f992d/image.webp 1440w,\n/static/2be52d1eec555424ea81a217aac71d6a/882b9/image.webp 1920w,\n/static/2be52d1eec555424ea81a217aac71d6a/37c59/image.webp 2040w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2be52d1eec555424ea81a217aac71d6a/09b79/image.jpg 240w,\n/static/2be52d1eec555424ea81a217aac71d6a/7cc5e/image.jpg 480w,\n/static/2be52d1eec555424ea81a217aac71d6a/6a068/image.jpg 960w,\n/static/2be52d1eec555424ea81a217aac71d6a/644c5/image.jpg 1440w,\n/static/2be52d1eec555424ea81a217aac71d6a/0f98f/image.jpg 1920w,\n/static/2be52d1eec555424ea81a217aac71d6a/46d55/image.jpg 2040w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2be52d1eec555424ea81a217aac71d6a/6a068/image.jpg\"\n            alt=\"Adventures in Android Timekeeping\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>My alarm clock regularly wakes me up at 6am or 06:00:00 to be exact. Time is a surprisingly variable concept. Atomic clocks define absolute precision, but in everyday life â€” like my alarm going off at 6:00 AM â€” a few seconds rarely matter.</p>\n<p>At work, I often have to deal with a bit more precise time since certain logical steps in mobile apps determine certain actions users can take. This led me to a rabbit hole of how time is determined on Android.</p>\n<h2 id=\"what-is-current-time\" style=\"position:relative;\"><a href=\"#what-is-current-time\" aria-label=\"what is current time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is current time</h2>\n<p><code class=\"language-text\">System.currentTimeMillis()</code> will return time in epoch format based on the deviceâ€™s current time. Accuracy of such is important in cases when some steps must be taken based on it, which are not validated on server, such as</p>\n<ul>\n<li>Batch Processing of data</li>\n<li>Adding timestamp to an event, which might be compared to backend timestamp.</li>\n<li>Enabling logic based on time of day (Example - stock market opening/closing on 9.15am/3.30pm)</li>\n</ul>\n<p>Unfortunately current time can be flawed based on</p>\n<ul>\n<li>User changing time and date</li>\n<li>Drift in automatic time</li>\n</ul>\n<h2 id=\"automatic-time\" style=\"position:relative;\"><a href=\"#automatic-time\" aria-label=\"automatic time permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Automatic time</h2>\n<p>When automatic time is enabled in device settings, Android devices synchronize their internal clock using NITZ(Network Identity and Time Zone), NTP(Network Time Protocol) or GPS. From Android 12, NTP is preferred way of synchronizing time.</p>\n<h4 id=\"nitz\" style=\"position:relative;\"><a href=\"#nitz\" aria-label=\"nitz permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NITZ</h4>\n<p>This data is broadcasted by cellular networks on periodic basis and received by Android OSâ€™s Radio Interface Layer, which then synchronizes internal clock. Unfortunately, the value in broadcast is not guaranteed and different cellular network may return different values, based on how they are maintaining their own clock.</p>\n<h4 id=\"ntp\" style=\"position:relative;\"><a href=\"#ntp\" aria-label=\"ntp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NTP</h4>\n<p>NTP uses servers which are geographically distributed systems, from which devices can sync timestamps. In general, even outside of mobile devices, this is considered best approach to sync time.\nFor Android, <code class=\"language-text\">time.android.com</code> is AOSPâ€™s default server which is also duplicated across geography. But this itself has certain limitations</p>\n<ul>\n<li>The device needs to compensate for the return trip time of the network call made to the NTP server, Android already does that but under assumption both legs of round trip take equivalent time and that difference is adjusted (<a href=\"https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/core/java/android/net/SntpClient.java;drc=61197364367c9e404c7da6900658f1b16c42d0da;l=229?q=Sntp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">source</a>).</li>\n<li>The default sync interval is 18 hours.</li>\n<li>Request to NTP server times out at 5 seconds, post which 3 retries will happen.</li>\n</ul>\n<p>All of these configs are overridable by OEMs/Carriers and they often are so this itself might vary across manufacturers/carriers.<br>\nExample - Some manufacturers prefer using local NTP servers like <code class=\"language-text\">in.pool.ntp.org</code> for India.<br>\nFun fact: Most of these servers have no SLAs for downtime ðŸ¤­</p>\n<h4 id=\"gnss\" style=\"position:relative;\"><a href=\"#gnss\" aria-label=\"gnss permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>GNSS</h4>\n<p>Satellite orbiting earth have atomic clocks which can send <a href=\"https://cs.android.com/android/platform/superproject/main/+/main:frameworks/base/services/core/java/com/android/server/timedetector/GnssTimeUpdateService.java;l=212;drc=61197364367c9e404c7da6900658f1b16c42d0da;bpv=0;bpt=1?q=GnssTimeUpdateService&#x26;ss=android%2Fplatform%2Fsuperproject%2Fmain\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">current time</a> along with location data when requested. These are highly accurate values, but available only when you have an active GPS signal.</p>\n<h2 id=\"source-of-drift\" style=\"position:relative;\"><a href=\"#source-of-drift\" aria-label=\"source of drift permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Source of drift</h2>\n<p>Backend services use their own NTP servers to capture timestamps, for example GCP uses <code class=\"language-text\">metadata.google.internal</code> as its NTP server. While both <code class=\"language-text\">time.android.com</code> and <code class=\"language-text\">metadata.google.internal</code> synchronize to Googleâ€™s authoritative time sources aiming for UTC, but this will rarely translate to client-backend timestamps since for a mobile client there is a factor of network latency, user settings and OEM overrides, where as backend VMs would be querying NTP over an internal network.</p>\n<p>In production, Iâ€™ve regularly seen a couple of seconds of drift between client and server â€” even with automatic time enabled. And if the user manually adjusts their clock? All bets are off.</p>\n<p>For most of the use cases, this doesnâ€™t cause any issue ðŸ˜…unless you have a time critical action to be executed at client without server validation (allow placement of orders, diffing frontend/backend latencies etc)</p>\n<h2 id=\"catch-my-drift\" style=\"position:relative;\"><a href=\"#catch-my-drift\" aria-label=\"catch my drift permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Catch my drift!</h2>\n<p>So whatâ€™s the solution, needless to say in general you should never trust the client, otherwise time drift will be the least of your problems. For other use cases</p>\n<ul>\n<li>Google now has a nice Trusted Time API which you can use (<a href=\"https://android-developers.googleblog.com/2025/02/trustedtime-api-introducing-reliable-approach-to-time-keeping-for-apps.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://android-developers.googleblog.com/2025/02/trustedtime-api-introducing-reliable-approach-to-time-keeping-for-apps.html</a> )</li>\n<li>You can deploy your own time service, potentially hosted regionally or on a CDN edge node to minimize latency for your clients, and use its timestamp consistently within your app.</li>\n</ul>\n<h2 id=\"fin\" style=\"position:relative;\"><a href=\"#fin\" aria-label=\"fin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fin</h2>\n<p>TL;DR time is hard</p>\n<p>Further reading on NTP: <a href=\"https://developers.google.com/time\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://developers.google.com/time</a></p>\n<p>If youâ€™re ever in London, donâ€™t miss the Greenwich time museum to learn the history of clocks and time itself.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/61532e1bb0e792fe2a87ac10bed6808e/47311/greenwich.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 177.91666666666669%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAkABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAEDBAUC/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAABzxrz53gXHPX56sqFZz7gHSBf/8QAHRAAAQQDAQEAAAAAAAAAAAAAAAECERIDITETMv/aAAgBAQABBQKiIKmqwOaOIHfDhp72x7JgzpXGnH9//8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAEDAQE/AQ4//8QAFhEAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAECAQE/AQo//8QAHRAAAgEEAwAAAAAAAAAAAAAAARAAAhExQQMykf/aAAgBAQAGPwI06MtpAvxdQZbCxOKz/8QAHxABAAIDAAEFAAAAAAAAAAAAAQARITFBYRCBofDx/9oACAEBAAE/IXCOlQ7sygBS/EzeAnUzOe7O3iHuaPZtZsC2Kir9gE3eCQ19I7N+h//aAAwDAQACAAMAAAAQFPYNeD//xAAYEQADAQEAAAAAAAAAAAAAAAAAARAhQf/aAAgBAwEBPxBmGlOz/8QAGREBAAIDAAAAAAAAAAAAAAAAAAEhEBFB/9oACAECAQE/EFqS05j/xAAgEAEAAwABBAMBAAAAAAAAAAABABEhMUFhcZFRgbHR/9oACAEBAAE/EBELQPhe1FWwqo5O5A3J0VaTwSz7IApenaCJRch5GALNr8CWODYAJVbALAVVC68zPeRi2k8v5A26t2F9IFDFrWqib9sdgFyJDT0n/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/61532e1bb0e792fe2a87ac10bed6808e/8ac56/greenwich.webp 240w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/d3be9/greenwich.webp 480w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/e46b2/greenwich.webp 960w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/260c2/greenwich.webp 1080w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/61532e1bb0e792fe2a87ac10bed6808e/09b79/greenwich.jpg 240w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/7cc5e/greenwich.jpg 480w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/6a068/greenwich.jpg 960w,\n/static/61532e1bb0e792fe2a87ac10bed6808e/47311/greenwich.jpg 1080w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/61532e1bb0e792fe2a87ac10bed6808e/6a068/greenwich.jpg\"\n            alt=\"greenwich\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>","fields":{"slug":"/posts/2025-15-04---adventures-in-android-timekeeping//posts/adventures-in-android-timekeeping/","tagSlugs":["/tag/android/"]},"frontmatter":{"date":"2025-04-15","tags":["Android"],"title":"Adventures in Android Timekeeping","description":"Understanding clock skew of System.currentTimeMillis() in Android","slug":"/posts/adventures-in-android-timekeeping/","socialImage":{"publicURL":"/static/2be52d1eec555424ea81a217aac71d6a/image.jpeg"}}}},"pageContext":{"slug":"/posts/2025-15-04---adventures-in-android-timekeeping//posts/adventures-in-android-timekeeping/"}},"staticQueryHashes":["4208939363"],"slicesMap":{}}