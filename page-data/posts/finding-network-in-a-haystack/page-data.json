{"componentChunkName":"component---src-templates-post-template-tsx","path":"/posts/finding-network-in-a-haystack/","result":{"data":{"markdownRemark":{"id":"3a584599-e6e1-563c-b1aa-1fb151afd281","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7a2a680950d73850a7efee9dd690337a/30f63/image.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACjUlEQVR42hXSW2/SAAAF4BpHS7m29E6hpbR0tJRCGQwYlw3YuCjIZBDAbW7CNkM2py5zTM30QafRaLwkGp+MDz4tmYm/wJj44ou/SZac15OcfDmACXaCFgSyY5CThFEGRBg1oCgBFXKydpJHOdHBCFbcY8FYGGPNTgpy4CYrOgU7JgFMFsSMkKADNyO0FWdB1NOp1Na6DSIih7rX1HaHkMKYP+xkRBvmsRNus4OGEAq0uaZgJwDTPJYqkKIuJCtKue/LNpdaw4VanZ7R9U5Xa7YJOYJ6NUqK8OWG1G8JrbKN5qCLCQRgxbnw0avC+K1WWQvMt1mjpOSb0mzVzmgYZ7Ba1h1M+1JVfeu2ut6nw8Xg4Ja3sGhx8RbcA0B2wl9uKStDxK3ifoORZ/K9Ua47kvONYL0vLvVC/S19766/vMbISVqaUTeH7FzN7CBNNhcwYYBsxHQ0l660E8VGvHAlvnB1tticHxwkDx6pve3pxoY7Upo0I7Vhor1fePE62tqR0w2cV4AJcixbDqcWSD7oVdJspMkayxifRN1hSkh51BKnV6hAnBCN+RuHq+9/Dn7/W/18vrR+yKqzgEcKxecWAZCgo73oxtPlb6PQ0Ym0ue3rbnGZqpApcUYWE3ScN/LjN+2zPysvvxd3nqRuHuK+EEBxSrK5LA6vi6MH8ceDxMO2sPsptHuinR7LvWFo/Cw+HmiD9eCdvfyHj7Wzv9XTs+TO81j/vn0CBpqR+Nfz+q8fTCxAaYKdFhxUEpfTmOR30kFEqZDxKp+PUboh5jqZe19y++8iq8feVB2agF26bGaMtJAomEDEBF9cBXaRMELBqGfyGStKWRAasjFWF+fgopic8cTKrkDCQvhNVvQ/49yE9YKI56oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7a2a680950d73850a7efee9dd690337a/8ac56/image.webp 240w,\n/static/7a2a680950d73850a7efee9dd690337a/d3be9/image.webp 480w,\n/static/7a2a680950d73850a7efee9dd690337a/e46b2/image.webp 960w,\n/static/7a2a680950d73850a7efee9dd690337a/f992d/image.webp 1440w,\n/static/7a2a680950d73850a7efee9dd690337a/882b9/image.webp 1920w,\n/static/7a2a680950d73850a7efee9dd690337a/b0136/image.webp 2816w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7a2a680950d73850a7efee9dd690337a/8ff5a/image.png 240w,\n/static/7a2a680950d73850a7efee9dd690337a/e85cb/image.png 480w,\n/static/7a2a680950d73850a7efee9dd690337a/d9199/image.png 960w,\n/static/7a2a680950d73850a7efee9dd690337a/07a9c/image.png 1440w,\n/static/7a2a680950d73850a7efee9dd690337a/29114/image.png 1920w,\n/static/7a2a680950d73850a7efee9dd690337a/30f63/image.png 2816w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7a2a680950d73850a7efee9dd690337a/d9199/image.png\"\n            alt=\"Finding Network in a haystack\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>I recently learned about spread spectrum technology (credit <a href=\"https://www.acquired.fm/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">acquired.fm</a>) - a communication technique developed decades ago that works by hopping signals across frequencies to improve reliability. What started as a way to make military communications jam-resistant eventually led to CDMA and the cellular networks we rely on today. The entire journey of how a communication signal travels is quite fascinating, and equally complex and deep when performing a simple step such as a network call on mobile.</p>\n<p>A simple HTTP request might seem straightforward, but under the hood, it’s a complex dance between your device, cellular towers, ISPs, and data centers. Each step in this chain can introduce latency, failures, or performance bottlenecks. Through real-world experimentation and production deployments, I’ve discovered several low-level optimizations that can dramatically improve network reliability and performance.</p>\n<h2 id=\"the-network-call-journey\" style=\"position:relative;\"><a href=\"#the-network-call-journey\" aria-label=\"the network call journey permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Network Call Journey</h2>\n<p>Before diving into optimizations, let’s understand what actually happens when your app makes a network request:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2501bb1f9597d8370d925c7b8052872a/ba715/connection_stages.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABYklEQVR42k2QO25UQRBFZw8sgy0QsQhiMkSAxEacI1JSZ4iAAAIkBBphyUi2BR7Pf/w+/bq7+vfezNiyDuUBAUGrSt23Tt3bo0ndMp5OmbWGPOzp0pbK99Qy4PNA7LfYWPCpJ2lfW8faeBpJuBAIuRDK9u8ZPXl1xIOXT3n+5jWiossm8eXS8m0uLG3BSuR8suJq1eBjZFI5xjPhZB659plUElJ2/4Bn6w0fL874UVXEsld3masqsmgTrfRI3mFDwcX+4KYLibXNLNt4cB1yUtB/wH57y83+jmF3S2s7jFdhcIi6Md7jxGns/e+hfA/I1Lp00wW91y8p+fAm+Q9QVOT7O8ScUr9/SPh5hPn0GDl9QTt+RvXhESl7jXVD7gszExlr3JNlYqV95y3XCv9+MaUywiiUgXDvIFpkcYx05/jlO6T+itt8xi7e6ub+4CJqbUSYNcJch40ETRNwGr22WmPhFxgKuxKqjmwIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/2501bb1f9597d8370d925c7b8052872a/8ac56/connection_stages.webp 240w,\n/static/2501bb1f9597d8370d925c7b8052872a/d3be9/connection_stages.webp 480w,\n/static/2501bb1f9597d8370d925c7b8052872a/e46b2/connection_stages.webp 960w,\n/static/2501bb1f9597d8370d925c7b8052872a/f992d/connection_stages.webp 1440w,\n/static/2501bb1f9597d8370d925c7b8052872a/882b9/connection_stages.webp 1920w,\n/static/2501bb1f9597d8370d925c7b8052872a/2b738/connection_stages.webp 2210w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/2501bb1f9597d8370d925c7b8052872a/8ff5a/connection_stages.png 240w,\n/static/2501bb1f9597d8370d925c7b8052872a/e85cb/connection_stages.png 480w,\n/static/2501bb1f9597d8370d925c7b8052872a/d9199/connection_stages.png 960w,\n/static/2501bb1f9597d8370d925c7b8052872a/07a9c/connection_stages.png 1440w,\n/static/2501bb1f9597d8370d925c7b8052872a/29114/connection_stages.png 1920w,\n/static/2501bb1f9597d8370d925c7b8052872a/ba715/connection_stages.png 2210w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/2501bb1f9597d8370d925c7b8052872a/d9199/connection_stages.png\"\n            alt=\"connection stages\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Each of these stages can fail or introduce delays. In a world of cellular networks, WiFi handoffs, and varying signal strengths, optimizing each step becomes crucial for a smooth user experience.</p>\n<h2 id=\"its-always-dns\" style=\"position:relative;\"><a href=\"#its-always-dns\" aria-label=\"its always dns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>It’s always DNS</h2>\n<p>DNS resolution is often the forgotten stepchild of network optimization, but it can easily add 50-200ms to the first request to a new domain. Here’s what actually happens during DNS resolution:</p>\n<p><strong>DNS Resolution Stages:</strong></p>\n<ol>\n<li><strong>Local Cache Check</strong> - Device checks its DNS cache</li>\n<li><strong>System Resolver</strong> - Query the system’s configured DNS server</li>\n<li><strong>Recursive Resolution</strong> - DNS server queries root servers, TLD servers, authoritative servers</li>\n<li><strong>Response Propagation</strong> - Result travels back through the chain</li>\n</ol>\n<p>Each of these stages can fail or be slow, especially on mobile networks where packet loss is common.</p>\n<h3 id=\"dns-subtleties-that-kill-performance\" style=\"position:relative;\"><a href=\"#dns-subtleties-that-kill-performance\" aria-label=\"dns subtleties that kill performance permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DNS Subtleties That Kill Performance</h3>\n<ul>\n<li><strong>Cache Invalidation</strong>: Low TTL can mean, devices need to resolve DNS frequently which might occur over unreliable or low-bandwidth paths.</li>\n<li><strong>Network Switching</strong>: Moving from WiFi to cellular (or vice versa) or fluctuations can clear DNS cache</li>\n</ul>\n<h3 id=\"optimizing-dns\" style=\"position:relative;\"><a href=\"#optimizing-dns\" aria-label=\"optimizing dns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Optimizing DNS</h3>\n<p>DNS can be optimized depending on your configurations. For eg. if you have static IPs, you can probably cache them for a longer time and refresh them asynchronously within your app.</p>\n<p>If IPs are dynamic, it’s probably not safe to cache them for a longer time but you can try to reduce errors by using a cached or a different static IP in case primary resolution fails.</p>\n<p><code class=\"language-text\">okhttp</code> allows you override DNS lookup which you can attach to your <code class=\"language-text\">Builder</code></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> CustomDns <span class=\"token operator\">:</span> Dns <span class=\"token punctuation\">{</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>InetAddress<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// With static IPs, check cache with a bit more relaxed expiry</span>\n        <span class=\"token keyword\">val</span> cached <span class=\"token operator\">=</span> <span class=\"token function\">getCachedAddresses</span><span class=\"token punctuation\">(</span>hostname<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cached <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> cached\n        \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Fallback to system DNS</span>\n            <span class=\"token keyword\">val</span> addresses <span class=\"token operator\">=</span> Dns<span class=\"token punctuation\">.</span>SYSTEM<span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span>hostname<span class=\"token punctuation\">)</span>\n            addresses\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> UnknownHostException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// With dynamic IPs, try to fallback to preconfigured static IP</span>\n            <span class=\"token function\">getStaticAddresses</span><span class=\"token punctuation\">(</span>hostname<span class=\"token punctuation\">)</span> <span class=\"token operator\">?:</span> <span class=\"token keyword\">throw</span> e\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getStaticAddresses</span><span class=\"token punctuation\">(</span>hostname<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>InetAddress<span class=\"token operator\">></span><span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">when</span> <span class=\"token punctuation\">(</span>hostname<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string-literal singleline\"><span class=\"token string\">\"api.myapp.com\"</span></span> <span class=\"token operator\">-></span> <span class=\"token function\">listOf</span><span class=\"token punctuation\">(</span>InetAddress<span class=\"token punctuation\">.</span><span class=\"token function\">getByName</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"x.xx.xxx.xx\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">null</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Depending on whether your objective is reliability or performance, overriding DNS resolution can be useful if you have users facing latency or connectivity challenges. I’ll discuss later in the article, how to identify these issues.</p>\n<h2 id=\"ip-addresses-can-deceive\" style=\"position:relative;\"><a href=\"#ip-addresses-can-deceive\" aria-label=\"ip addresses can deceive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IP addresses can deceive</h2>\n<p>DNS returns IP address(es), to one of which a connection must be made. Most modern servers will publish multiple IP addresses which can be often used as means of load balancing or handling requests from different geographies.</p>\n<p>Often these are combinations of IPv4 and IPv6, where lies our next challenge.</p>\n<p><strong>The Problem:</strong>\nIPv6 was launched more than a decade ago, to address (pun intended) exhaustion of IPv4 addresses. Like all large-scale migrations, its quirks are still felt today</p>\n<p>Today largely all servers would support IPv6+IPv4, where IPv6 is preferred if available via AAAA record. The clients will prefer the same if they themselves support IPv6 along with a connected network.\nHere lies the problem, there are many layers between client, their nearest network and servers which may not be configured for IPv6.</p>\n<p><strong>Connection Flow (Traditional):</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/345c6a2821aa513e676eaaac6ea93c8c/e8e04/ip_address_sequential_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACMklEQVR42o1Ty27TUBDNn/BDrPgA2KCKDwD1E9jDgk0XCFiVBR/ApgIVUQRJCq3tKo2dJnZsXz+vX9ehlQ4zk7YCKRVZHM21fX1mzpmZwYFt4dn+W+y+f4en+29w4Fjo+ivo1iCpDKywgxO1OA1q2FEHL+lQdz1K+l7UHYI4xyLO5Fw2BoP7L55j8PgB7u0+kcjPkSownQeY+CnG/gqHdoyPQ4/OBid+jaXK4BPRPMzxdWjhaGTD8xOkZYPBh+/f8GjvJXZev8JDivxctyvkukFUNDgJOhxfaIy8Ar/8FlPVSjV5xdEQkYK7iJHpdl1hT/JMf4nWXErsV1fy4Qa66VC1vYDPumXw2SBMCiKMcbFUCFQmCQbrTN0t8msvGHyBfUyrfh3rnsDVNXI3IxXzMMEiSkluva7w72puiQgVmR6VBp+cFIeOwpezFJ8thaGbwZp4mC0TLJMSp5M5fjoekeaUqNtMKFKJUGmD0UxjPCvEwx9ujnPVSDL+Oc4q8e98HiJKS6n6TsIbVN0KqqDOkl++ykWayrVYU5vf1O1UwOc7Jf9baY84rwhayNivM3ch1TAJNyagRJx4K8JKCDWiTKMhAkZI8njmWLLj+rCnPr3TMkr/JWTwRa5iESU0JpF0lj1b0gIc2x7BlaZk2xLqxlyPSYuEZPu0amxFRSvI3jJYyVaSN4Gr5ViblXjKFW/dlE3gbrOPvM8sd2y5tC3p9h5uGnz2i7vvBbTLtM8RNYXn8A8WY1/wjUy5wwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/345c6a2821aa513e676eaaac6ea93c8c/8ac56/ip_address_sequential_2.webp 240w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/d3be9/ip_address_sequential_2.webp 480w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/e46b2/ip_address_sequential_2.webp 960w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/3979e/ip_address_sequential_2.webp 1270w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/345c6a2821aa513e676eaaac6ea93c8c/8ff5a/ip_address_sequential_2.png 240w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/e85cb/ip_address_sequential_2.png 480w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/d9199/ip_address_sequential_2.png 960w,\n/static/345c6a2821aa513e676eaaac6ea93c8c/e8e04/ip_address_sequential_2.png 1270w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/345c6a2821aa513e676eaaac6ea93c8c/d9199/ip_address_sequential_2.png\"\n            alt=\"ip address sequential 2\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>The major challenge here is that if you have multiple IPv6 addresses, which are non-functional for certain users, there will be multiple attempts with timeouts (typically 10-15 seconds), before you actually get a connection success, leading to overall latency of 30-60s.</p>\n<h3 id=\"fast-fallback-algorithm\" style=\"position:relative;\"><a href=\"#fast-fallback-algorithm\" aria-label=\"fast fallback algorithm permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fast Fallback Algorithm</h3>\n<p>The solution is <a href=\"https://datatracker.ietf.org/doc/html/rfc6555\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Happy Eyeballs (RFC 8305)</a> - make parallel connection attempts to all available IP addresses and return the fastest successful connection.</p>\n<p><strong>Optimized Connection Flow:</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/6b26f/ip_address_parallel.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.5%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABiUlEQVR42n1Sy06DQBTlF0z8Jn/DuNGtfoN717rUz3CjJi7UdFNNpVZqa3kMMAMDDDBtoznemUqa1MfiZAZuOPc8cG6GLq5dF5OUo9ZLqHaBuGjh5xohIchbZEqjauYoao28aiBVi/L7eRPO1uEuto/2sHNyjJgXCFiK57DBvVfgdsDQDzQmcYlESASpRO9pBHccQJS1Jd0kdvbPT3FwcYbTq0sUpCQrFd54iye/Qn+awWUtmCRVpIzLGsO3wCIk8jgrwbiEKNSacL74gMFy+bneqMyQTrpLtd6u9AKprKzliOdEmtn3TBRrwpyGHX7LpIMkpKRk7McIkgx+LOAzTo5qeO8hqVdWjPMfyQqrjMp2jliUGLzO8DqNkOQVMorBzAx5/n13NlVUjYaX1HicVRhQjiZL0zoji36y+jDJlSUeTSJbjomhK+cHoWo1XiKFuxFHz+N48ARYoRFRXtMwtRZF2eCFihnPGGZMkGVmSzJ5/2m5K6jbXNH/adDNzd3MDOEzqfXpNAq/AFqIoQOvQ/svAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/8ac56/ip_address_parallel.webp 240w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/d3be9/ip_address_parallel.webp 480w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/e46b2/ip_address_parallel.webp 960w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/f992d/ip_address_parallel.webp 1440w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/237a5/ip_address_parallel.webp 1658w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/8ff5a/ip_address_parallel.png 240w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/e85cb/ip_address_parallel.png 480w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/d9199/ip_address_parallel.png 960w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/07a9c/ip_address_parallel.png 1440w,\n/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/6b26f/ip_address_parallel.png 1658w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/75cbbefe7c8c8caf5f9f5323e2e6cfa8/d9199/ip_address_parallel.png\"\n            alt=\"ip address parallel\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Thankfully most modern clients support this internally. Chrome, Firefox, even iOS <code class=\"language-text\">UrlSession</code> enable it by default.</p>\n<p>In OkHttp, you can enable this with(default since v5.0):</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> client <span class=\"token operator\">=</span> OkHttpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">fastFallback</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4 id=\"the-hardware-reality\" style=\"position:relative;\"><a href=\"#the-hardware-reality\" aria-label=\"the hardware reality permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The Hardware Reality</h4>\n<p>I faced the above problem, when using a different <a href=\"https://github.com/nats-io/nats.java\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">client</a> for networking needs than <code class=\"language-text\">okhttp</code>, where we would find some users running into persistent disconnections over IPv6 addresses.\nWhile clients attempting to connect to IPv6 have been informed by network to use it, the underlying network isn’t actually ready for these addresses. This is largely due to :</p>\n<ul>\n<li>Cellular tower configuration issues</li>\n<li>ISP routing problems</li>\n<li>Corporate firewall policies</li>\n<li>Home router misconfigurations</li>\n</ul>\n<p>We later figured out that <strong>~3%</strong> users can’t connect to IPv6, even when DNS resolves it for them and end up connecting to IPv4 addresses. It is also more likely to happen on a wifi connection than a cellular one.</p>\n<h2 id=\"making-attempts-faster\" style=\"position:relative;\"><a href=\"#making-attempts-faster\" aria-label=\"making attempts faster permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Making attempts faster</h2>\n<p>Clients often come up with a default set of values around timeouts, optimisations which might be counterintuitive in certain use cases. For example, <code class=\"language-text\">okhttp</code> has</p>\n<ul>\n<li>Default timeout of 10s for connections</li>\n<li>Default timeout of 10s for read/write requests.</li>\n<li>Max 5 concurrent calls per host, while limiting it to 64 globally.</li>\n</ul>\n<p>Increasing concurrent calls per host might be worth it if all calls use the same host, which can be the usual case for mobile apps.</p>\n<p>In terms of timeout, it might be worth experimenting if failing fast with lower timeouts helps with app experience. It also forces you to look at your own infrastructure in terms of what you need to change to reach users in let’s say &#x3C;5 seconds.</p>\n<p>Another advantage here is faster timeouts can capture degraded TCP connections faster. Let me take an HTTP detour to expand on this.</p>\n<h3 id=\"http-1--2\" style=\"position:relative;\"><a href=\"#http-1--2\" aria-label=\"http 1  2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP 1 &#x26; 2</h3>\n<p>HTTP 1 makes requests over connection sequentially, which means if one request is slow, all others in line become slow as well. This can be mitigated by creating a bunch of connections and splitting requests over them.</p>\n<p>HTTP2 solves this by multiplexing requests over a single connection as different streams, which can be dispatched and returned in any sequence.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/ea64c/http1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABn0lEQVR42m1S2ZLaMBD0//9ZjkqAcC1mA75PyYcsyTx1ZmZx2IJ96NJIdrempxX0k8dg5xecK4uwtLKea/eB+1nROYzulcNagR4tam3QdAZtPxEMSj3h23XCJveCVTIJ/hQev1OPkIT1YIg3yv/MY35nHALeZLXGe5wjLhoUjUZc9/gRWexJ4FDO+HXpsIoGHKneZA4n6rLRPS5pJbysVqLRGYtgsF7a53YZXCvj8TOesC2cYEfCu9JLvSbBv43D5B82eV00Am7zGQN9yGlOcWuRqFeo8ZXDEMHHDbf/w9V0tkktdebItiPbXsD1NneIWgdzD+UzTwTVMNHceiRli5zmULY90mbE98iK1T3P8NpjFY8yz/V9hi0FkpQKadUSvxMNCUUNFpUaRZAH2+gBOe055S0lvCtmEVsnhuZINaV84pQpXf4/KRtpoiKeCH62vLytjs4OZO+tnnEihM2N1pvUx2pGqh6WjX+yvKTb3bFcwDfyM0orJV1k1Yc9xlecBUH/dMBtc6fXrML6cMY+vGIXXnB8j3A4R7JfEv0K/wAA5j4U/eJGpAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/8ac56/http1.webp 240w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/d3be9/http1.webp 480w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/e46b2/http1.webp 960w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/36c36/http1.webp 1116w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/8ff5a/http1.png 240w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/e85cb/http1.png 480w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/d9199/http1.png 960w,\n/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/ea64c/http1.png 1116w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/99f1dfa4e8fc6ceb4cd730b5705ddbe2/d9199/http1.png\"\n            alt=\"http1\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/25186e8adc3c7b94e53671fd96573159/62a6a/http2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABKklEQVR42m2Q21LCQBBE+f9PsxRFKQUNkL0Rks39sgRf2pkJBMvyoXd2ku1TM72o+4C6P4uqLqCh6soBygfo/KZBKn9zZZjf/vZV3XRf2LTATh+hjxlcViLxFZa6x9IErI9nvJHWyShV5AKSooVNc0Tki10K5yefAFXisd1r7AxBTx7qVODVDXi2AZtsxMq0eIg8PtIR7yeG0pR5A0UDsC9SDszgYQQYO4/N7vqDHhkCPtGEj2ogcMCLJbjpsaK7yE7A2GXi+4qt3HlTAfL+ed2haHqULWcYcKDMVHmBqb6hq6ka6uNihMrDlFnLvv7qG+ZMF3w0w0g6zyELlCKIYoODTaBI3Ce+QBfG+zvx3fsZ+Fc8Ka+z/txL3R4MNpSXpqzacEH1j+cG/AEU1Q05XpvKGwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/25186e8adc3c7b94e53671fd96573159/8ac56/http2.webp 240w,\n/static/25186e8adc3c7b94e53671fd96573159/d3be9/http2.webp 480w,\n/static/25186e8adc3c7b94e53671fd96573159/e46b2/http2.webp 960w,\n/static/25186e8adc3c7b94e53671fd96573159/e6b69/http2.webp 1122w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/25186e8adc3c7b94e53671fd96573159/8ff5a/http2.png 240w,\n/static/25186e8adc3c7b94e53671fd96573159/e85cb/http2.png 480w,\n/static/25186e8adc3c7b94e53671fd96573159/d9199/http2.png 960w,\n/static/25186e8adc3c7b94e53671fd96573159/62a6a/http2.png 1122w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/25186e8adc3c7b94e53671fd96573159/d9199/http2.png\"\n            alt=\"http2\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>The only blocker here is the TCP connection here itself, since TCP acknowledges every packet sent, a packet loss at any request will pause all request streams until lost packet is retrieved. Packet loss is more prevalent in fluctuating mobile networks.</p>\n<p>Shorter timeouts can force clients to revalidate their connection <a href=\"https://github.com/square/okhttp/blob/4e7860212f3d873b37b69e4f0a882cf60bb91dd7/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Connection.kt#L530\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">health</a> faster, upon which you can fail fast and retry on a newer (hopefully better) path when the network is fluctuating.</p>\n<p><strong>Timeout Strategy:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> client <span class=\"token operator\">=</span> OkHttpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">connectTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">readTimeout</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>Parallel Connection Limits:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> dispatcher <span class=\"token operator\">=</span> <span class=\"token function\">Dispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ndispatcher<span class=\"token punctuation\">.</span>maxRequestsPerHost <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n\n<span class=\"token keyword\">val</span> client <span class=\"token operator\">=</span> OkHttpClient<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">dispatcher</span><span class=\"token punctuation\">(</span>dispatcher<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"http3-return-of-udp\" style=\"position:relative;\"><a href=\"#http3-return-of-udp\" aria-label=\"http3 return of udp permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HTTP3: Return of UDP</h2>\n<p>HTTP/3 uses <a href=\"https://www.chromium.org/quic/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">QUIC</a> protocol, which runs over UDP instead of TCP. This solves several fundamental issues with TCP:</p>\n<p><strong>TCP Problems QUIC Solves:</strong></p>\n<ul>\n<li><strong>Head-of-line blocking</strong>: One lost packet blocks all streams</li>\n<li><strong>Connection setup</strong>: Requires multiple round trips</li>\n<li><strong>Mobility</strong>: Connections break when switching networks</li>\n</ul>\n<p><strong>Mobile-Specific Advantages:</strong></p>\n<ul>\n<li><strong>Connection Migration</strong>: Maintains connection when switching from WiFi to Mobile</li>\n<li><strong>Better Loss Recovery</strong>: Per-stream recovery instead of connection-wide</li>\n<li><strong>Reduced Latency</strong>: Built-in encryption, no separate TLS handshake</li>\n</ul>\n<p>Unfortunately, <code class=\"language-text\">okhttp</code> doesn’t support HTTP3 natively, but we can use Google’s <a href=\"https://developer.android.com/develop/connectivity/cronet\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Cronet</a> library, which can also plug into <code class=\"language-text\">okhttp</code> stack but with limited <a href=\"https://github.com/google/cronet-transport-for-okhttp\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">features</a>.</p>\n<p><strong>Fun side note</strong></p>\n<p>Google introduced <a href=\"https://www.chromium.org/spdy/spdy-whitepaper/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">SPDY</a> protocol to overcome HTTP1 limitations, which eventually was used in HTTP2. Same is repeated with QUIC, which was introduced by Google and eventually made it’s way to HTTP3.</p>\n<h2 id=\"measurement\" style=\"position:relative;\"><a href=\"#measurement\" aria-label=\"measurement permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Measurement</h2>\n<p>If using <code class=\"language-text\">okhttp</code> , you can attach an <code class=\"language-text\">EventListener</code> to the <code class=\"language-text\">Builder</code>, which can then be used to measure different stages of http calls.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> MetricsListener <span class=\"token operator\">:</span> <span class=\"token function\">EventListener</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">callEnd</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">callStart</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">connectStart</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">,</span> inetSocketAddress<span class=\"token operator\">:</span> InetSocketAddress<span class=\"token punctuation\">,</span> proxy<span class=\"token operator\">:</span> Proxy<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">connectEnd</span><span class=\"token punctuation\">(</span>\n        call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">,</span>\n        inetSocketAddress<span class=\"token operator\">:</span> InetSocketAddress<span class=\"token punctuation\">,</span>\n        proxy<span class=\"token operator\">:</span> Proxy<span class=\"token punctuation\">,</span>\n        protocol<span class=\"token operator\">:</span> Protocol<span class=\"token operator\">?</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">dnsStart</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">,</span> domainName<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">dnsEnd</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">,</span> domainName<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> inetAddressList<span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>InetAddress<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">secureConnectStart</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">secureConnectEnd</span><span class=\"token punctuation\">(</span>call<span class=\"token operator\">:</span> Call<span class=\"token punctuation\">,</span> handshake<span class=\"token operator\">:</span> Handshake<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">EventListener</code> is quite extensive, and can be used to get metrics around cache hit, dns, SSL and much more. You can push these metrics to your favorite analytics/observability system and analyze patterns around carrier, geography etc.</p>\n<h2 id=\"conclusion\" style=\"position:relative;\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h2>\n<p>Just like spread spectrum technology spread signals across multiple frequencies to survive interference, modern mobile apps need to spread their bets across multiple optimization strategies. DNS caching handles resolution failures, fast fallback survives IPv6 connectivity issues, aggressive timeouts help recover from degraded connections, and HTTP/3 promises to solve fundamental TCP limitations.</p>\n<p>The network will always be unreliable - that’s the one constant we can count on. But by understanding each stage of the network journey and optimizing for the realities of mobile communication, we can build apps that feel fast and reliable even when the underlying infrastructure isn’t.</p>\n<p>Next time a user complains about network performance, you’ll know it’s not just “the network is slow” - it’s a complex chain of optimizable steps waiting to be fine-tuned.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 710px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/26fa0c720c4397587e1628200f923dc0/67e9d/meme.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAABAUA/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAABpz1To0fiZH//xAAaEAEAAgMBAAAAAAAAAAAAAAABAgMAETIS/9oACAEBAAEFAnXpVtjeA8QXIc//xAAXEQEAAwAAAAAAAAAAAAAAAAAAAQIh/9oACAEDAQE/AYsx/8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8Bh//EABwQAAEDBQAAAAAAAAAAAAAAAAACETEBEEJxgf/aAAgBAQAGPwJx0v0iorRONv/EABsQAQADAAMBAAAAAAAAAAAAAAEAESExQWHR/9oACAEBAAE/IXbaV4Bd46jgV3zJzu/iMdXCJRbc/9oADAMBAAIAAwAAABCzH//EABcRAQADAAAAAAAAAAAAAAAAAAARQXH/2gAIAQMBAT8Qgph//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERUf/aAAgBAgEBPxBl3T//xAAaEAEBAAMBAQAAAAAAAAAAAAABEQAhUUGx/9oACAEBAAE/EKEAAX7lXUtiPGSy6ldHMBokKPpgTTs2+3HZF1bn/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/26fa0c720c4397587e1628200f923dc0/8ac56/meme.webp 240w,\n/static/26fa0c720c4397587e1628200f923dc0/d3be9/meme.webp 480w,\n/static/26fa0c720c4397587e1628200f923dc0/457aa/meme.webp 710w\"\n              sizes=\"(max-width: 710px) 100vw, 710px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/26fa0c720c4397587e1628200f923dc0/09b79/meme.jpg 240w,\n/static/26fa0c720c4397587e1628200f923dc0/7cc5e/meme.jpg 480w,\n/static/26fa0c720c4397587e1628200f923dc0/67e9d/meme.jpg 710w\"\n            sizes=\"(max-width: 710px) 100vw, 710px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/26fa0c720c4397587e1628200f923dc0/67e9d/meme.jpg\"\n            alt=\"meme\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>","fields":{"slug":"/posts/2025-05-08---finding-network-in-a-haystack//posts/finding-network-in-a-haystack/","tagSlugs":["/tag/android/","/tag/network/"]},"frontmatter":{"date":"2025-08-05","tags":["Android","Network"],"title":"Finding Network in a haystack","description":"Low-level discoveries for improving network reliability and performance in mobile apps","slug":"/posts/finding-network-in-a-haystack/","socialImage":{"publicURL":"/static/7a2a680950d73850a7efee9dd690337a/image.png"}}}},"pageContext":{"slug":"/posts/2025-05-08---finding-network-in-a-haystack//posts/finding-network-in-a-haystack/"}},"staticQueryHashes":["4208939363"],"slicesMap":{}}