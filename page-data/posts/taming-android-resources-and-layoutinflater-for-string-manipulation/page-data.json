{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/taming-android-resources-and-layoutinflater-for-string-manipulation/","result":{"data":{"markdownRemark":{"id":"2e21bdbe-ff6a-5c8e-98a5-a943236d4e85","html":"<p>Recently I was working on a problem where we wanted to make our string resources dynamic. In every app, there are strings which would often come from backend APIs and are dynamic by nature, but a lot of strings are packaged in <code class=\"language-text\">strings.xml</code>. There might be requirements to make few of these dynamic as well for eg. A/B testing etc. The major pain point here is these strings would have usages spread all over codebase and there is no default way to override <code class=\"language-text\">strings.xml</code> to make them dynamic.</p>\n<p>One solution is to move away from <code class=\"language-text\">strings.xml</code> and keep strings as constant objects or a map. But moving away from <code class=\"language-text\">strings.xml</code> has few disadvantages such as </p>\n<ul>\n<li>Strings cannot be used in layout preview</li>\n<li>Need new logic for localisation</li>\n<li>Large migration cost of removing string references in existing code base.</li>\n</ul>\n<p>So we want to come up with a solution where we can keep <code class=\"language-text\">strings.xml</code> as well as have dynamic updates to them.</p>\n<p>In this article I’ll try to explain my experiments with string retrieval process to override default string values.</p>\n<h2 id=\"string-packaging-and-aapt-\" style=\"position:relative;\"><a href=\"#string-packaging-and-aapt-\" aria-label=\"string packaging and aapt  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>String packaging and AAPT 🔡</h2>\n<p>Let’s first understand why key-value pairs in <code class=\"language-text\">strings.xml</code> cannot be dynamic by nature.</p>\n<p>Here’s an example of string resource in <code class=\"language-text\">strings.xml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hello_world<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Hello World!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>string</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>We can access this string in one of these ways depending on whether we are retrieving it in xml or kotlin file</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">android:text=\"@string/hello_world\" //xml</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">context<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">.</span>string<span class=\"token punctuation\">.</span>hello_world<span class=\"token punctuation\">)</span> <span class=\"token comment\">//kotlin</span></code></pre></div>\n<p><code class=\"language-text\">R.string.hello_world</code> is a constant integer which is created by <code class=\"language-text\">aapt</code> and added to <code class=\"language-text\">R.java</code> along with other constants.\nOnce an <code class=\"language-text\">apk</code> is generated strings are packaged in <code class=\"language-text\">resources.arsc</code> along with other xml data. Here’s a image of our packaged string along with it’s generated id.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6f9695f7c9e70b93ef45bce488a17261/9c2d2/resource-arsc-preview.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAbklEQVQI102JsQ6CMAAF+azKgosUSgm0GCNQExlYgBkwhm8/iYg6XO5dnhdpS2LrlYq0uCGzkjivOOnL2o6jtATSbA7Ne+/8PvO1p84t2X1Bu4m8WZDlg6h+El5HUjfj6wGhekSycfjw3/sWquMFObBNnzshpKgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6f9695f7c9e70b93ef45bce488a17261/8ac56/resource-arsc-preview.webp 240w,\n/static/6f9695f7c9e70b93ef45bce488a17261/d3be9/resource-arsc-preview.webp 480w,\n/static/6f9695f7c9e70b93ef45bce488a17261/e46b2/resource-arsc-preview.webp 960w,\n/static/6f9695f7c9e70b93ef45bce488a17261/f992d/resource-arsc-preview.webp 1440w,\n/static/6f9695f7c9e70b93ef45bce488a17261/882b9/resource-arsc-preview.webp 1920w,\n/static/6f9695f7c9e70b93ef45bce488a17261/3b8fd/resource-arsc-preview.webp 2226w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6f9695f7c9e70b93ef45bce488a17261/8ff5a/resource-arsc-preview.png 240w,\n/static/6f9695f7c9e70b93ef45bce488a17261/e85cb/resource-arsc-preview.png 480w,\n/static/6f9695f7c9e70b93ef45bce488a17261/d9199/resource-arsc-preview.png 960w,\n/static/6f9695f7c9e70b93ef45bce488a17261/07a9c/resource-arsc-preview.png 1440w,\n/static/6f9695f7c9e70b93ef45bce488a17261/29114/resource-arsc-preview.png 1920w,\n/static/6f9695f7c9e70b93ef45bce488a17261/9c2d2/resource-arsc-preview.png 2226w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6f9695f7c9e70b93ef45bce488a17261/d9199/resource-arsc-preview.png\"\n            alt=\"resource arsc preview\"\n            title=\"resource arsc preview\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>The id here <code class=\"language-text\">0x7f100027</code> represents the integer value of <code class=\"language-text\">R.string.hello_world</code>.\nAny layout file referencing this string value using <code class=\"language-text\">@string</code> is also re-written with same id.</p>\n<p>-> <code class=\"language-text\">activity_main.xml</code> packaged in apk</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>TextView</span>\n\t<span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_width</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>-2<span class=\"token punctuation\">\"</span></span>\n\t<span class=\"token attr-name\"><span class=\"token namespace\">android:</span>layout_height</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>-2<span class=\"token punctuation\">\"</span></span>\n\t<span class=\"token attr-name\"><span class=\"token namespace\">android:</span>text</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>@ref/0x7f100027<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<p>Similar replacement also happens in java/kotlin bytecode when they are referenced using <code class=\"language-text\">R.string.*</code> integers.</p>\n<p>-> <code class=\"language-text\">dex</code> bytecode for <code class=\"language-text\">MainActivity.kt</code></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token punctuation\">.</span>line <span class=\"token number\">22</span>\n<span class=\"token keyword\">const</span> v0<span class=\"token punctuation\">,</span> <span class=\"token number\">0x7f100027</span>\ninvoke<span class=\"token operator\">-</span>virtual <span class=\"token punctuation\">{</span>p0<span class=\"token punctuation\">,</span> v0<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Lin<span class=\"token operator\">/</span>jitinsharma<span class=\"token operator\">/</span>stringplayground<span class=\"token operator\">/</span>MainActivity<span class=\"token punctuation\">;</span><span class=\"token operator\">-></span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>I<span class=\"token punctuation\">)</span>Ljava<span class=\"token operator\">/</span>lang<span class=\"token operator\">/</span>String<span class=\"token punctuation\">;</span>\nmove<span class=\"token operator\">-</span>result<span class=\"token operator\">-</span><span class=\"token keyword\">object</span> v0\n<span class=\"token keyword\">const</span><span class=\"token operator\">-</span>string v1<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"getString(R.string.hello_world)\"</span></span></code></pre></div>\n<p>These constant ids are generated in build time and are randomised during each build. Hence it’s not possible to update them dynamically.</p>\n<h2 id=\"investigating-method-callstack-️\" style=\"position:relative;\"><a href=\"#investigating-method-callstack-%EF%B8%8F\" aria-label=\"investigating method callstack ️ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Investigating method callstack 🕵️</h2>\n<p>While it’s not viable to update string files themselves, but we could try overriding methods which actually retrieve strings.\nIn this section we explore the same.</p>\n<p>At a lower level, there are always two classes involved when a string is retrieved</p>\n<ul>\n<li>Resources - When <code class=\"language-text\">getString</code> is used java/kotlin</li>\n<li>TypedArray - When <code class=\"language-text\">@string/</code> is used in xml</li>\n</ul>\n<p>Let’s investigate each of them one by one.</p>\n<h2 id=\"resourceful-resources-\" style=\"position:relative;\"><a href=\"#resourceful-resources-\" aria-label=\"resourceful resources  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resourceful Resources 📚</h2>\n<p>Let’s look at first option of retrieving string via <code class=\"language-text\">getString</code> method. The <code class=\"language-text\">getString</code> methods calls up following chain of methods</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">── context<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    └── Resources #<span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        └── AssetManager #<span class=\"token function\">getResourceValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            └── ApkAssets #<span class=\"token function\">getStringFromPool</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                └── StringBlock #<span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>All classes in this chain are final, except <code class=\"language-text\">Resources</code>. Let’s poke it 🕵️‍♂️</p>\n<p>We start by subclassing <code class=\"language-text\">Resources</code> to create a <code class=\"language-text\">CustomResource</code> class.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">CustomResources</span><span class=\"token punctuation\">(</span>\n    res<span class=\"token operator\">:</span> Resources<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> dynamicStringMap<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">Resources</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>assets<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>displayMetrics<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">.</span>configuration<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The moment you override Resources, you’ll be welcomed with following deprecation ⚠️ warning ⚠️</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">@deprecated Resources should not be constructed by apps.</code></pre></div>\n<p>Since Resources can be overridden on configuration change, overriding resources is discouraged. Ignoring this warning for now(ofcourse at your risk) 🤷‍♂️</p>\n<p>Here we have also have <code class=\"language-text\">dynamicStringMap</code> which is an in-memory map of strings which have been fetched from backend. It’s good to keep this structure in memory so the string access is faster since your views might request a lot of strings in their layout cycle. </p>\n<p>Overriding resources allows us to override following methods</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getStringArray</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getStringArray</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getText</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> CharSequence <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// More overrides available</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">getString</code> and <code class=\"language-text\">getStringArray</code> are for standard strings and string-arrays which you have declared in <code class=\"language-text\">strings.xml</code></li>\n<li><code class=\"language-text\">getText</code> is invoked for any text with custom formatting present within xml.</li>\n</ul>\n<p>Each of these methods accept integer as a parameter which is equivalent to what you would pass when calling these methods with <code class=\"language-text\">R.string.*</code></p>\n<p>Now we apply a simple redirection in one of these methods</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">/**\n* For a given id, this function checks if string for that key \n* should be retrieved from dynamic string map.\n* If not present, it fallbacks to super call which will retrieve string from strings.xml\n**/</span>\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> String <span class=\"token punctuation\">{</span>               <span class=\"token comment\">// id=0x7f100027</span>\n    <span class=\"token keyword\">val</span> name <span class=\"token operator\">=</span> <span class=\"token function\">getResourceEntryName</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>                 <span class=\"token comment\">// name=hello_world</span>\n    <span class=\"token keyword\">return</span> dynamicStringMap<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">?:</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token comment\">// dynamicStringMap[name]=Hello Android!</span>\n                                                        <span class=\"token comment\">// super.getString(id)=Hello World!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Similar to <code class=\"language-text\">getString</code>, you can set up redirects to <code class=\"language-text\">getStringArray</code>, <code class=\"language-text\">getQuantityString</code>(for <code class=\"language-text\">&lt;plurals></code>) and many more functions.</p>\n<p>Now we have our custom resources, we need to attach them to our context. This can be done by creating a custom ContextWrapper.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">CustomContextWrapper</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> base<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> dynamicStringMap<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">ContextWrapper</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getResources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">CustomResources</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">,</span> dynamicStringMap<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p><strong>ContextWrapper allow us to override context by providing a new copy of it. The exisiting context remains intact.</strong></p>\n</blockquote>\n<p>Now we can attach this CustomContextWrapper in our activity</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token comment\">// MainActivity.kt</span>\n<span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">attachBaseContext</span><span class=\"token punctuation\">(</span>newBase<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">attachBaseContext</span><span class=\"token punctuation\">(</span><span class=\"token function\">CustomContextWrapper</span><span class=\"token punctuation\">(</span>newBase<span class=\"token punctuation\">,</span> dynamicStringMap<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>Note</strong>: ContextWrappers are needed to be attached only at Activity. Fragments, Custom View end up inheriting context from container activity itself.</p>\n<p>You can also attach ContextWrapper to base activity if you have one or manually add this to all activities(or write an annotation processor to automate it 🙂 )</p>\n<p>Once we complete this setup</p>\n<ul>\n<li>We have a <code class=\"language-text\">dynamicStringMap</code> which contains subset of strings which need to be dynamic.</li>\n<li>All <code class=\"language-text\">getString</code> calls are routed through our custom resources which decides which string value should be returned.</li>\n<li>All implementation details of <code class=\"language-text\">getString</code> in our codebase remain untouched.</li>\n</ul>\n<p>The problem is half solved though, we still need to figure out a solution for <code class=\"language-text\">@string</code> in xml resources.</p>\n<h2 id=\"finding-view-in-a-haystack-\" style=\"position:relative;\"><a href=\"#finding-view-in-a-haystack-\" aria-label=\"finding view in a haystack  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Finding view in a haystack 🔍</h2>\n<p>String values in xml layouts are not resolved from <code class=\"language-text\">Resources</code>, hence our existing solution doesn’t work for strings referenced in layout files and in most of codebases we are still dependent on xml layouts so it’s not something we can ignore.</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\">android:text=\"@string/hello_world\"</code></pre></div>\n<p>Any text referenced in xml via <code class=\"language-text\">@string</code> is resolved by corresponding View using <code class=\"language-text\">TypedArray</code>.\n<code class=\"language-text\">TypedArray</code> is final by definition and cannot be subclassed.</p>\n<blockquote>\n<p><code class=\"language-text\">TypedArray</code> is an internal android class which is used to retrieve attributes from various xml resources. All Views use <code class=\"language-text\">TypedArray</code> to get attributes such as <code class=\"language-text\">text</code>, <code class=\"language-text\">layout_width</code> etc. TypedArray is also recycled for optimisation and reuse.</p>\n</blockquote>\n<p><code class=\"language-text\">TypedArray</code> is important and can’t be overridden. So now what?</p>\n<p>While we can’t override text which is reaching <code class=\"language-text\">TextView</code> from <code class=\"language-text\">TypedArray</code>, we can always override the view itself!</p>\n<p>All views are inflated using <code class=\"language-text\">LayoutInflater</code> and this class itself can be overridden to create a <code class=\"language-text\">CustomLayoutInflater</code>. Again, I should warn you about creating Custom LayoutInflater may come with it’s own set of unintended issues(but that hasn’t stopped us till now 😛 ).</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> CustomLayoutInflater <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n    original<span class=\"token operator\">:</span> LayoutInflater<span class=\"token punctuation\">,</span>\n    newContext<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">LayoutInflater</span><span class=\"token punctuation\">(</span>original<span class=\"token punctuation\">,</span> newContext<span class=\"token punctuation\">)</span></code></pre></div>\n<p>Overriding <code class=\"language-text\">LayoutInflater</code> needs overriding a lot of functions and classes such as <code class=\"language-text\">Factory</code>, <code class=\"language-text\">Factory2</code>. What we are looking specifically is for a function which creates view.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">onCreateView</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">,</span> attrs<span class=\"token operator\">:</span> AttributeSet<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> View<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> view <span class=\"token operator\">=</span> <span class=\"token function\">createView</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"android.widget.\"</span></span><span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>view <span class=\"token keyword\">is</span> TextView<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// Here we get original TextView and then return it after overriding text</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">overrideTextView</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> ClassNotFoundException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>inflateException<span class=\"token operator\">:</span> InflateException<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">onCreateView</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> attrs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>We override <code class=\"language-text\">onCreateView</code> of <code class=\"language-text\">LayoutInflater</code> and intercept views with prefix <code class=\"language-text\">android.widget.</code> which contains <code class=\"language-text\">TextView</code> class.</li>\n<li>With this we intercept all <code class=\"language-text\">TextView</code>(s) which are inflated but before they are actually painted on screen.</li>\n</ul>\n<p>Now onto overriding the TextView</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">overrideTextView</span><span class=\"token punctuation\">(</span>view<span class=\"token operator\">:</span> TextView<span class=\"token punctuation\">,</span> attrs<span class=\"token operator\">:</span> AttributeSet<span class=\"token operator\">?</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> TextView <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">val</span> typedArray <span class=\"token operator\">=</span> view<span class=\"token punctuation\">.</span>context<span class=\"token punctuation\">.</span><span class=\"token function\">obtainStyledAttributes</span><span class=\"token punctuation\">(</span>attrs<span class=\"token punctuation\">,</span> <span class=\"token function\">intArrayOf</span><span class=\"token punctuation\">(</span>android<span class=\"token punctuation\">.</span>R<span class=\"token punctuation\">.</span>attr<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">val</span> stringResource <span class=\"token operator\">=</span> typedArray<span class=\"token punctuation\">.</span><span class=\"token function\">getResourceId</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    view<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> view<span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">.</span><span class=\"token function\">getText</span><span class=\"token punctuation\">(</span>stringResource<span class=\"token punctuation\">)</span>\n    typedArray<span class=\"token punctuation\">.</span><span class=\"token function\">recycle</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> view\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Using same old <code class=\"language-text\">TypedArray</code>, we find out the id of string resources at <code class=\"language-text\">android:text</code> location in xml. Once we get the id, we again call <code class=\"language-text\">resources.getText</code> which will route through our <code class=\"language-text\">CustomResources</code> implementation and then set the new string to     <code class=\"language-text\">TextView</code>.</p>\n<p>Now that we have our <code class=\"language-text\">CustomLayoutInflater</code> ready, we need to attach it to <code class=\"language-text\">CustomContextWrapper</code> we had created earlier.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">class</span> <span class=\"token function\">CustomContextWrapper</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> base<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> dynamicStringMap<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span>String<span class=\"token punctuation\">,</span> String<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">ContextWrapper</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getResources</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token function\">CustomResources</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">.</span>resources<span class=\"token punctuation\">,</span> dynamicStringMap<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Any<span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Context<span class=\"token punctuation\">.</span>LAYOUT_INFLATER_SERVICE <span class=\"token operator\">==</span> name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token function\">CustomLayoutInflater</span><span class=\"token punctuation\">(</span>LayoutInflater<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>baseContext<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">super</span><span class=\"token punctuation\">.</span><span class=\"token function\">getSystemService</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"side-note\" style=\"position:relative;\"><a href=\"#side-note\" aria-label=\"side note permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Side Note</h4>\n<p>We can avoid complexities of overriding <code class=\"language-text\">LayoutInflater</code> by using <a href=\"https://github.com/InflationX/ViewPump\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ViewPump</a> which does the same job and provides an API for intercepting view inflation.</p>\n<h2 id=\"resources-loaders-\" style=\"position:relative;\"><a href=\"#resources-loaders-\" aria-label=\"resources loaders  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resources Loaders 🔮</h2>\n<p>Android 11 has introduced ability to load resources dynamically via <code class=\"language-text\">ResourcesLoader</code> and <code class=\"language-text\">ResourcesProvider</code>. This is not just restricted to string files but also allows dynamic loading of drawables and other resource files. This is an approximate way of using these classes</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> provider <span class=\"token operator\">=</span> ResourcesProvider<span class=\"token punctuation\">.</span><span class=\"token function\">loadFromDirectory</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"/somepath/\"</span></span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n\t\t\t\t\t\t\t\t<span class=\"token comment\">// or loadFromApk()</span>\n<span class=\"token keyword\">val</span> loader <span class=\"token operator\">=</span> <span class=\"token function\">ResourcesLoader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nloader<span class=\"token punctuation\">.</span><span class=\"token function\">addProvider</span><span class=\"token punctuation\">(</span>provider<span class=\"token punctuation\">)</span>\nresources<span class=\"token punctuation\">.</span><span class=\"token function\">addLoaders</span><span class=\"token punctuation\">(</span>loader<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Application resources</span></code></pre></div>\n<p>There aren’t proper samples of this API provided right now and it’s only available on Android 11 and above, so there is a long time for this API to be usable for majority of apps.</p>\n<h3 id=\"recap\" style=\"position:relative;\"><a href=\"#recap\" aria-label=\"recap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Recap</h3>\n<ul>\n<li>We created an in-memory map of strings fetched from server.</li>\n<li>We created <code class=\"language-text\">CustomResources</code> to override string retrieval and redirect it to fetch dynamic strings from map.</li>\n<li>We created <code class=\"language-text\">CustomLayoutInflater</code> to reset text of TextViews inflated from xml with string resource.</li>\n<li>We patched all of this together in <code class=\"language-text\">CustomContextWrapper</code> which is attached to each activity overriding it’s context.</li>\n</ul>\n<h3 id=\"faq\" style=\"position:relative;\"><a href=\"#faq\" aria-label=\"faq permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FAQ</h3>\n<ul>\n<li>\n<p>Should i do this?</p>\n<p>Depends. There are other alternatives like moving away from xml string resources to normal class objects/variables as strings which won’t require above overrides to system classes. But larger codebases may not have that luxury.</p>\n</li>\n<li>\n<p>Is anyone else doing this?</p>\n<p>There are a lot of open source libraries like <a href=\"https://github.com/JcMinarro/Philology\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Philogy</a> and even commercial ones like <a href=\"https://github.com/crowdin/mobile-sdk-android\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Crowdin</a> which use this approach. So there are teams somewhere adopting this approach.</p>\n</li>\n<li>\n<p>Is it enough to override <code class=\"language-text\">TextView</code>?</p>\n<p>No. <code class=\"language-text\">TextView</code> might represent bulk of text displayed on your UI but there are classes like <code class=\"language-text\">Toolbar</code> which also display text without a <code class=\"language-text\">TextView</code> component. You can override these classes as well in <code class=\"language-text\">CustomLayoutInflater</code>.</p>\n</li>\n<li>\n<p>What are performance impacts?</p>\n<p>I did some performance analysis on my own projects and found results to be kind of inconclusive. Layout inflation time did increase but % varied from 4 to 38 in one case. I guess it’s better to trace layout inflation time for your project and check if increase is within limits.</p>\n</li>\n</ul>\n<p>Thanks for reading!</p>","fields":{"slug":"/posts/taming-android-resources-and-layoutinflater-for-string-manipulation/","tagSlugs":["/tag/android/"]},"frontmatter":{"date":"2020-07-28","description":"Intercepting string resources for dynamic updates.","tags":["Android"],"title":"Taming Android Resources and LayoutInflater for string manipulation","banner":null}}},"pageContext":{"slug":"/posts/taming-android-resources-and-layoutinflater-for-string-manipulation/"}},"staticQueryHashes":["1122560877","251939775","401334301"]}